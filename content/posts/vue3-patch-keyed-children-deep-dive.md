---
title: "Vue 3 æºç æ ¸å¿ƒç¬”è®°ï¼šä¹±åº Diff (Unknown Sequence) æ·±åº¦è§£æ"
date: 2026-02-13
draft: false
description: "æ·±åº¦å‰–æ Vue 3 Diff ç®—æ³•ä¸­æœ€å¤æ‚çš„ä¹±åºå¤„ç†é€»è¾‘ï¼Œç†è§£ Map æŸ¥æ‰¾ã€LIS ç®—æ³•ã€å€’åºéå†ç­‰æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥"
tags: ["Vue3", "ç®—æ³•", "æºç åˆ†æ", "Diffç®—æ³•"]
categories: ["ç¬”è®°"]
---

## 1. ä»€ä¹ˆæ˜¯â€œä¹±åº Diffâ€ï¼Ÿ

åœ¨ Vue 3 çš„ Diff ç®—æ³•ï¼ˆ`patchKeyedChildren`ï¼‰ä¸­ï¼ŒVue ä¼šä¼˜å…ˆå¤„ç†â€œå¤´éƒ¨åŒæ­¥â€å’Œâ€œå°¾éƒ¨åŒæ­¥â€ã€‚å½“æå¤´å»å°¾åï¼Œå¦‚æœæ–°æ—§åˆ—è¡¨éƒ½è¿˜æœ‰å‰©ä½™èŠ‚ç‚¹ï¼Œä¸”é¡ºåºä¸ä¸€è‡´ï¼Œå°±ä¼šè¿›å…¥æœ€å¤æ‚çš„ **ä¹±åº Diff (Unknown Sequence)** é˜¶æ®µã€‚

**åœºæ™¯ç¤ºä¾‹ï¼š**

- **æ—§åˆ—è¡¨ (Old):** `a b (c d e z) f g`
- **æ–°åˆ—è¡¨ (New):** `a b (e c d h) f g`

å»æ‰å¤´éƒ¨çš„ `a b` å’Œå°¾éƒ¨çš„ `f g`ï¼Œå‰©ä¸‹çš„å°±æ˜¯æˆ‘ä»¬è¦å¤„ç†çš„æ ¸å¿ƒä¹±åºåŒºé—´ï¼š

- **Old å¾…å¤„ç†:** `c d e z` (ç´¢å¼•: 2, 3, 4, 5)
- **New å¾…å¤„ç†:** `e c d h` (ç´¢å¼•: 2, 3, 4, 5)

Vue çš„ç›®æ ‡æ˜¯ï¼š**å¤ç”¨èƒ½å¤ç”¨çš„ï¼Œåˆ é™¤å¤šä½™çš„ï¼Œæ–°å¢æ²¡æœ‰çš„ï¼Œå¹¶ç”¨æœ€å°‘çš„æ­¥æ•°ç§»åŠ¨ DOMã€‚**

## 2. æ ¸å¿ƒæµç¨‹ä¸‰éƒ¨æ›²

ä¹±åº Diff çš„å¤„ç†é€»è¾‘å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š

1. **å»ºç«‹ç´¢å¼•å›¾ (Build Map)**ï¼šä¸ºæ–°èŠ‚ç‚¹å»ºç«‹æŸ¥æ‰¾è¡¨ã€‚
2. **æ¸…ç†æ—§èŠ‚ç‚¹ (Clean Old)**ï¼šéå†æ—§èŠ‚ç‚¹ï¼Œè¿›è¡Œæ‰“è¡¥ä¸ (Patch) æˆ– åˆ é™¤ (Unmount)ã€‚
3. **ç§»åŠ¨ä¸æŒ‚è½½ (Move & Mount)**ï¼šåˆ©ç”¨ LIS ç®—æ³•ï¼Œç§»åŠ¨èŠ‚ç‚¹æˆ–æŒ‚è½½æ–°èŠ‚ç‚¹ã€‚

### ä¹±åº Diff æµç¨‹å›¾

{{< mermaid >}}
flowchart TD
Start([å¼€å§‹ä¹±åºå¤„ç†<br/>Unknown Sequence]) --> Step1[æ­¥éª¤1: å»ºç«‹ç´¢å¼•å›¾<br/>Build keyToNewIndexMap]

    Step1 --> InitVars[åˆå§‹åŒ–å˜é‡<br/>patched=0, moved=false<br/>maxNewIndexSoFar=0]
    InitVars --> Step2[æ­¥éª¤2: éå†æ—§èŠ‚ç‚¹<br/>oldStartIndex to oldEnd]

    Step2 --> CheckFull{patched å¤§äºç­‰äº<br/>toBePatched?}
    CheckFull -->|æ˜¯<br/>åé¢å·²æ»¡| UnmountB[Unmount<br/>ç›´æ¥åˆ é™¤]
    CheckFull -->|å¦| FindInMap{åœ¨ Map ä¸­<br/>æ‰¾åˆ° Key?}

    FindInMap -->|æœªæ‰¾åˆ°| UnmountA[Unmount<br/>æŸ¥æ— æ­¤äºº]
    FindInMap -->|æ‰¾åˆ°| RecordMap[è®°å½•æ˜ å°„<br/>newIndexToOldIndexMap]

    RecordMap --> CheckOrder{newIndex å¤§äºç­‰äº<br/>maxNewIndexSoFar?}
    CheckOrder -->|æ˜¯<br/>é€’å¢| UpdateMax[æ›´æ–°æ°´ä½çº¿<br/>maxNewIndexSoFar = newIndex]
    CheckOrder -->|å¦<br/>ä¹±åº| SetMoved[æ ‡è®° moved = true]

    UpdateMax --> PatchNode[Patch å¤ç”¨èŠ‚ç‚¹<br/>patched++]
    SetMoved --> PatchNode

    PatchNode --> MoreOld{è¿˜æœ‰æ—§èŠ‚ç‚¹?}
    UnmountA --> MoreOld
    UnmountB --> MoreOld
    MoreOld -->|æ˜¯| CheckFull
    MoreOld -->|å¦| Step3

    Step3[æ­¥éª¤3: ç§»åŠ¨ä¸æŒ‚è½½] --> CheckMoved{moved ç­‰äº true?}
    CheckMoved -->|æ˜¯| CalcLIS[è®¡ç®— LIS<br/>getSequence]
    CheckMoved -->|å¦| SkipLIS[è·³è¿‡ LIS è®¡ç®—<br/>increasingNewIndexSequence = ç©º]

    CalcLIS --> ReverseLoop[å€’åºéå†æ–°èŠ‚ç‚¹<br/>toBePatched-1 to 0]
    SkipLIS --> ReverseLoop

    ReverseLoop --> CalcAnchor[è®¡ç®—é”šç‚¹ Anchor<br/>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ el]
    CalcAnchor --> CheckValue{æ˜ å°„å€¼<br/>ç­‰äº 0?}

    CheckValue -->|æ˜¯<br/>æ–°èŠ‚ç‚¹| Mount[Mount<br/>æŒ‚è½½æ–°èŠ‚ç‚¹]
    CheckValue -->|å¦| CheckMovedAgain{éœ€è¦ç§»åŠ¨?}

    CheckMovedAgain -->|moved=false| Skip[Skip<br/>è·³è¿‡ä¸åŠ¨]
    CheckMovedAgain -->|moved=true| InLIS{åœ¨ LIS ä¸­?}

    InLIS -->|æ˜¯| Skip
    InLIS -->|å¦| Move[Move<br/>ç§»åŠ¨èŠ‚ç‚¹]

    Mount --> MoreNew{è¿˜æœ‰æ–°èŠ‚ç‚¹?}
    Skip --> MoreNew
    Move --> MoreNew
    MoreNew -->|æ˜¯| CalcAnchor
    MoreNew -->|å¦| End([ç»“æŸ])

    classDef startEnd stroke:#0ea5e9,stroke-width:3px
    classDef buildStep stroke:#8b5cf6,stroke-width:2px
    classDef cleanStep stroke:#f59e0b,stroke-width:2px
    classDef moveStep stroke:#06b6d4,stroke-width:2px
    classDef unmountNode stroke:#ef4444,stroke-width:2px
    classDef patchNode stroke:#10b981,stroke-width:2px
    classDef lisNode stroke:#8b5cf6,stroke-width:2px,stroke-dasharray:5 5

    class Start,End startEnd
    class Step1,InitVars,FindInMap buildStep
    class Step2,CheckFull,RecordMap,CheckOrder,UpdateMax,SetMoved cleanStep
    class Step3,CheckMoved,ReverseLoop,CalcAnchor,CheckValue,CheckMovedAgain,InLIS moveStep
    class UnmountA,UnmountB unmountNode
    class PatchNode,Mount,Move patchNode
    class CalcLIS,SkipLIS lisNode

{{< /mermaid >}}

### ç¬¬ä¸€æ­¥ï¼šå»ºç«‹æ–°èŠ‚ç‚¹ç´¢å¼•å›¾ (KeyToNewIndexMap)

Vue ä¸ºäº†é¿å…åœ¨éå†æ—§èŠ‚ç‚¹æ—¶ä½¿ç”¨åŒé‡å¾ªç¯ï¼ˆå¯¼è‡´ å¤æ‚åº¦ï¼‰ï¼Œé¦–å…ˆä¼šéå†ä¸€é**æ–°èŠ‚ç‚¹åˆ—è¡¨**ï¼Œç”Ÿæˆä¸€ä¸ª `Map`ã€‚

- **ç›®çš„**ï¼šå®ç° `O(1)` çš„å¿«é€ŸæŸ¥æ‰¾ã€‚
- **è¾“å…¥**ï¼š`New: [e, c, d, h]` (ç´¢å¼• 2, 3, 4, 5)
- **è¾“å‡ºç»“æœ (Map)**ï¼š

```javascript
// key : newIndex
{ 'e': 2, 'c': 3, 'd': 4, 'h': 5 }

```

### ç¬¬äºŒæ­¥ï¼šéå†æ—§èŠ‚ç‚¹ (æ ¸å¿ƒï¼šPatch ä¸ Unmount)

è¿™æ˜¯æœ€ç¹å¿™çš„ä¸€æ­¥ã€‚Vue éå†**æ—§èŠ‚ç‚¹**ï¼Œæ‹¿ç€æ—§èŠ‚ç‚¹çš„ Key å»ä¸Šé¢çš„ Map é‡Œæ‰¾ã€‚è¿™é‡Œæ¶‰åŠå¤šä¸ªæ ¸å¿ƒé€»è¾‘çš„åˆ¤æ–­ã€‚

#### 2.1 æ·±åº¦è§£æï¼š`newIndexToOldIndexMap` çš„ç§˜å¯†

Vue åˆ›å»ºäº†ä¸€ä¸ªå•çº¯çš„æ•´æ•°æ•°ç»„ `newIndexToOldIndexMap`ï¼Œä½†å®ƒæ‰¿è½½äº†æ–°æ—§èŠ‚ç‚¹ä½ç½®å…³ç³»çš„å…¨éƒ¨ä¿¡æ¯ã€‚

**å®ƒçš„â€œç´¢å¼•â€å’Œâ€œå€¼â€åˆ°åº•ä»£è¡¨ä»€ä¹ˆï¼Ÿ**

æ•°ç»„å®šä¹‰ï¼š`const newIndexToOldIndexMap = new Array(toBePatched)` (åˆå§‹åŒ–ä¸º 0)

1. **æ•°ç»„çš„ç´¢å¼• (Index)**ï¼šä»£è¡¨ **æ–°å­èŠ‚ç‚¹ (New Children)** çš„ç›¸å¯¹ä½ç½®ã€‚

- `Index 0`ï¼šè¡¨ç¤ºæ–°åˆ—è¡¨ä¹±åºéƒ¨åˆ†é‡Œçš„ **ç¬¬ 1 ä¸ª** èŠ‚ç‚¹ã€‚

2. **æ•°ç»„çš„å€¼ (Value)**ï¼šä»£è¡¨è¯¥èŠ‚ç‚¹åœ¨ **æ—§å­èŠ‚ç‚¹ (Old Children)** åˆ—è¡¨ä¸­çš„ **åŸå§‹ä½ç½® + 1**ã€‚

- **ä¸ºä»€ä¹ˆè¦ +1ï¼Ÿ** è¿™æ˜¯ä¸ºäº†æŠŠ `0` è¿™ä¸ªå€¼ç©ºå‡ºæ¥ï¼Œä¸“é—¨ç”¨æ¥æ ‡è®° **â€œè¿™æ˜¯ä¸€ä¸ªå…¨æ–°èŠ‚ç‚¹â€**ã€‚

**å¯è§†åŒ–å¡«ç©ºæ¼”ç¤ºï¼š**

- **Old å¾…å¤„ç†:** `[c, d, e]` (ç´¢å¼•: 2, 3, 4)
- **New å¾…å¤„ç†:** `[e, c, d, h]` (ç´¢å¼•: 2, 3, 4, 5)

| æ•°ç»„ç´¢å¼• (i) | å¯¹åº”æ–°èŠ‚ç‚¹ | æ—§åˆ—è¡¨ç´¢å¼• (OldIdx) | **å¡«å…¥çš„å€¼ (OldIdx + 1)** | å«ä¹‰è§£è¯»                           |
| ------------ | ---------- | ------------------- | ------------------------- | ---------------------------------- |
| **0**        | **`e`**    | `4`                 | **`5`**                   | æ–°åˆ—è¡¨ç¬¬1ä¸ªæ˜¯ `e`ï¼ŒåŸæ—§åˆ—è¡¨ç¬¬4ä½ã€‚ |
| **1**        | **`c`**    | `2`                 | **`3`**                   | æ–°åˆ—è¡¨ç¬¬2ä¸ªæ˜¯ `c`ï¼ŒåŸæ—§åˆ—è¡¨ç¬¬2ä½ã€‚ |
| **2**        | **`d`**    | `3`                 | **`4`**                   | æ–°åˆ—è¡¨ç¬¬3ä¸ªæ˜¯ `d`ï¼ŒåŸæ—§åˆ—è¡¨ç¬¬3ä½ã€‚ |
| **3**        | **`h`**    | `undefined`         | **`0`**                   | æ–°åˆ—è¡¨ç¬¬4ä¸ªæ˜¯ `h`ï¼Œæ—§åˆ—è¡¨æ²¡æœ‰å®ƒã€‚  |

**æœ€ç»ˆæ•°ç»„çŠ¶æ€ï¼š** `[5, 3, 4, 0]`

#### 2.2 ä»€ä¹ˆæ—¶å€™æ‰§è¡Œ Unmount (åˆ é™¤)ï¼Ÿ

åœ¨éå†æ—§èŠ‚ç‚¹æ—¶ï¼Œåªæœ‰ä¸¤ç§æƒ…å†µä¼šè§¦å‘ `unmount`ï¼š

**æƒ…å†µ Aï¼šæŸ¥æ— æ­¤äºº (Lost Node)**

- **é€»è¾‘**ï¼šæ‹¿ç€æ—§èŠ‚ç‚¹çš„ Key å» Map é‡Œæ‰¾ï¼Œè¿”å› `undefined`ã€‚
- **å«ä¹‰**ï¼šæ–°æ•°æ®é‡Œæ²¡æœ‰è¿™ä¸ªèŠ‚ç‚¹äº†ï¼Œè¯´æ˜ç”¨æˆ·æŠŠå®ƒåˆ äº†ã€‚
- **æ“ä½œ**ï¼šç›´æ¥å¸è½½ã€‚

**æƒ…å†µ Bï¼šåé¢å·²æ»¡ (Overflow)**

- **é€»è¾‘**ï¼š`patched >= toBePatched`ã€‚
- **å«ä¹‰**ï¼šæ–°åˆ—è¡¨é‡Œä¸€å…±åªéœ€è¦ 4 ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘å·²ç»æˆåŠŸå¤ç”¨ 4 ä¸ªäº†ã€‚å‰©ä¸‹çš„æ—§èŠ‚ç‚¹ä¸ç®¡ Map é‡Œæœ‰æ²¡æœ‰ï¼Œéƒ½æ˜¯å¤šä½™çš„ã€‚
- **æ“ä½œ**ï¼šç›´æ¥å¸è½½ï¼Œä¸æŸ¥ Mapï¼ŒèŠ‚çœæ€§èƒ½ã€‚

#### 2.3 æ·±åº¦è§£æï¼šMove çš„è§¦å‘æœºåˆ¶ (maxNewIndexSoFar)

åœ¨éå†æ—§èŠ‚ç‚¹æ—¶ï¼ŒVue ç»´æŠ¤äº†ä¸€ä¸ªå…³é”®å˜é‡ `maxNewIndexSoFar`ï¼ˆç›®å‰ä¸ºæ­¢é‡åˆ°çš„æœ€å¤§æ–°ç´¢å¼•ï¼‰ã€‚å®ƒçš„ä½œç”¨å°±åƒä¸€æ¡ **â€œæœ€é«˜æ°´ä½çº¿â€**ï¼Œç”¨æ¥æ£€æµ‹èŠ‚ç‚¹é¡ºåºæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚

**æ ¸å¿ƒé€»è¾‘ï¼š**

- **ç†æƒ³æƒ…å†µï¼ˆé€’å¢ï¼‰**ï¼šå¦‚æœåˆ—è¡¨åªæ˜¯å¢åŠ æˆ–åˆ é™¤äº†èŠ‚ç‚¹ï¼Œä½†ç›¸å¯¹é¡ºåºæ²¡å˜ï¼Œé‚£ä¹ˆ `newIndex` åº”è¯¥æ˜¯ **ä¸€ç›´å˜å¤§** çš„ã€‚
- **ä¹±åºæƒ…å†µï¼ˆéé€’å¢ï¼‰**ï¼šä¸€æ—¦å‘ç°å½“å‰çš„ `newIndex` æ¯”ä¹‹å‰çš„â€œæœ€é«˜æ°´ä½çº¿â€è¿˜è¦å°ï¼Œè¯´æ˜ **è¿™ä¸ªèŠ‚ç‚¹â€œæ‰é˜Ÿâ€äº†**ï¼ˆå‘ç”Ÿäº†ä¹±åºï¼‰ã€‚

**åœºæ™¯æ¼”ç¤ºï¼šéœ€è¦ç§»åŠ¨ (moved = true)**

- **Old:** `[A, B, C]`
- **New:** `[C, A, B]` (C è·‘åˆ°äº†æœ€å‰é¢)

| éå†æ—§èŠ‚ç‚¹ | åœ¨æ–°åˆ—è¡¨çš„ç´¢å¼• (newIndex) | æ°´ä½çº¿ (maxNewIndexSoFar) | åˆ¤æ–­é€»è¾‘            | ç»“æœ                    |
| ---------- | ------------------------- | ------------------------- | ------------------- | ----------------------- |
| **A**      | `1`                       | `0` (åˆå§‹)                | `1 >= 0` (True)     | æ›´æ–°æ°´ä½çº¿ -> `1`       |
| **B**      | `2`                       | `1`                       | `2 >= 1` (True)     | æ›´æ–°æ°´ä½çº¿ -> `2`       |
| **C**      | **`0`**                   | **`2`**                   | **`0 < 2` (False)** | **æ ‡è®° `moved = true`** |

**ç»“è®º**ï¼š`moved` ä¸º trueï¼Œå¿…é¡»å¯åŠ¨ LIS ç®—æ³•æ¥è®¡ç®—æœ€å°ç§»åŠ¨æ¬¡æ•°ã€‚

#### 2.4 æ·±åº¦è§£æï¼šPatch (æ‰“è¡¥ä¸) çš„è§¦å‘æ—¶æœº

`patch` æ˜¯ Vue æ¸²æŸ“å™¨çš„æ ¸å¿ƒå…¥å£ï¼Œåœ¨ä¹±åº Diff ä¸­ï¼Œåªæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¼šè°ƒç”¨å®ƒï¼š

**åœºæ™¯ Aï¼šè€å‹é‡é€¢ (Reuse & Update)**

- **è§¦å‘**ï¼šåœ¨éå†æ—§èŠ‚ç‚¹æ—¶ï¼Œæ‹¿ç€ Key åœ¨ Map é‡Œ **æ‰¾åˆ°äº†** å¯¹åº”çš„æ–°èŠ‚ç‚¹ã€‚
- **åŠ¨ä½œ**ï¼š`patch(prevChild, nextChild, ...)`ã€‚
- **ä½œç”¨**ï¼šå¤ç”¨ DOM å…ƒç´ ï¼Œåªæ›´æ–°å˜åŒ–çš„å±æ€§ï¼ˆProps/Childrenï¼‰ã€‚

**åœºæ™¯ Bï¼šæ–°ç”Ÿå‘½è¯ç”Ÿ (Mount)**

- **è§¦å‘**ï¼šåœ¨å€’åºéå†æ—¶ï¼Œå‘ç° `newIndexToOldIndexMap` çš„å€¼ä¸º **`0`**ã€‚
- **åŠ¨ä½œ**ï¼š`patch(null, nextChild, ...)`ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ä¸º nullï¼‰ã€‚
- **ä½œç”¨**ï¼šåˆ›å»ºå…¨æ–°çš„ DOM å…ƒç´ å¹¶æŒ‚è½½ã€‚

### ç¬¬ä¸‰æ­¥ï¼šç§»åŠ¨ä¸æŒ‚è½½ (LIS ç®—æ³•ç™»åœº)

ç°åœ¨æ—§èŠ‚ç‚¹å¤„ç†å®Œäº†ï¼Œæˆ‘ä»¬å¾—åˆ°äº†å…³é”®æ•°ç»„ `newIndexToOldIndexMap`: **`[5, 3, 4, 0]`**ã€‚

#### 3.1 è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ— (LIS)

Vue å¯¹ `[5, 3, 4]` (å»æ‰ 0) è®¡ç®— LISã€‚

- **ç»“æœ**ï¼š`[3, 4]` (å¯¹åº”çš„ç´¢å¼•æ˜¯ 1 å’Œ 2)ã€‚
- **å«ä¹‰**ï¼šæ–°åˆ—è¡¨é‡Œçš„ç¬¬ 2 ä¸ª (`c`) å’Œç¬¬ 3 ä¸ª (`d`) èŠ‚ç‚¹ï¼Œ**ç›¸å¯¹é¡ºåºæ˜¯å¯¹çš„ï¼Œä¸éœ€è¦ç§»åŠ¨**ã€‚

#### 3.2 æ·±åº¦è§£æï¼šMove é€»è¾‘ä¸é”šç‚¹ (Anchor) çš„å¥¥ç§˜

ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼š**â€œVue æ€ä¹ˆçŸ¥é“è¦æŠŠè¿™ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°å“ªé‡Œï¼Ÿæ˜¯æ’åœ¨è°å‰é¢ï¼Œè¿˜æ˜¯è°åé¢ï¼Ÿâ€**

è¿™é‡Œéšè—ç€ Vue 3 ç®—æ³•è®¾è®¡çš„ä¸€ä¸ªå¤§æ™ºæ…§ï¼š**å€’åºéå† (Backwards Iteration)**ã€‚

**ä¸ºä»€ä¹ˆå¿…é¡»å€’åºï¼Ÿ**
DOM åŸç”Ÿ API åªæœ‰ `insertBefore`ï¼ˆæ’å…¥åˆ°æŸèŠ‚ç‚¹ä¹‹å‰ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æƒ³æŠŠèŠ‚ç‚¹æ”¾åˆ°æ­£ç¡®ä½ç½®ï¼Œå¿…é¡»**å…ˆç¡®å®šå®ƒâ€œåé¢â€çš„é‚£ä¸ªèŠ‚ç‚¹æ˜¯è°**ï¼Œé‚£ä¸ªèŠ‚ç‚¹å°±æ˜¯ **é”šç‚¹ (Anchor)**ã€‚

- **å€’åºéå†**ï¼šå¤„ç†ç¬¬ `i` ä¸ªèŠ‚ç‚¹æ—¶ï¼Œç¬¬ `i+1` ä¸ªèŠ‚ç‚¹ï¼ˆå³è¾¹çš„é‚»å±…ï¼‰**è‚¯å®šå·²ç»å¤„ç†å®Œæ¯•äº†**ï¼ˆè¦ä¹ˆæ˜¯åˆšæŒ‚è½½çš„æ–°èŠ‚ç‚¹ï¼Œè¦ä¹ˆæ˜¯å·²ç»å½’ä½çš„æ—§èŠ‚ç‚¹ï¼‰ã€‚

**å¯è§†åŒ–ç§»åŠ¨æ¨æ¼”ï¼š**
å‡è®¾ Old `[B, C]` -> New `[C, B]`ã€‚

1. **å¤„ç†æœ€åä¸€ä¸ªèŠ‚ç‚¹ `B`**ï¼š
   - å®ƒæ˜¯æ–°åˆ—è¡¨çš„æœ€åä¸€ä¸ªã€‚
   - **è®¡ç®—é”šç‚¹**ï¼šåé¢æ²¡äººäº† -> `anchor = null`ã€‚
   - **åŠ¨ä½œ**ï¼š`insertBefore(B, null)` -> ç­‰åŒäº `appendChild(B)`ã€‚
   - _æ­¤æ—¶ B å½’ä½åˆ°æœ€åã€‚_

2. **å¤„ç†å€’æ•°ç¬¬äºŒä¸ªèŠ‚ç‚¹ `C`**ï¼š
   - å®ƒåé¢æ˜¯ `B`ã€‚
   - **è®¡ç®—é”šç‚¹**ï¼š`newChildren[Bçš„ç´¢å¼•].el` -> **å³ DOM ä¸­çš„ B èŠ‚ç‚¹**ã€‚
   - **åŠ¨ä½œ**ï¼š`insertBefore(C, B)` -> **æŠŠ C æ’åˆ° B å‰é¢**ã€‚
   - _æ­¤æ—¶ C å½’ä½ã€‚_

## 4. æºç è¯¦è§£ä¸å˜é‡é€ŸæŸ¥ (Source Code Deep Dive)

è¿™ä¸€éƒ¨åˆ†å±•ç¤ºäº† `patchKeyedChildren` ä¸­å¤„ç†ä¹±åºçš„æ ¸å¿ƒä»£ç ï¼Œå¹¶é™„å¸¦äº†é€è¡Œæ³¨é‡Šã€‚

```javascript
// 5. unknown sequence (ä¹±åºå¤„ç†æ ¸å¿ƒé€»è¾‘)
else {
  const oldStartIndex = i
  const newStartIndex = i

  // -------------------------------------------------------------
  // 5.1 å»ºç«‹ç´¢å¼•å›¾ (Build Map)
  // -------------------------------------------------------------
  const keyToNewIndexMap = new Map()
  for (i = newStartIndex; i <= newChildrenEnd; i++) {
    const nextChild = (newChildren[i] = normalizeVNode(newChildren[i]))
    if (nextChild.key != null) {
      keyToNewIndexMap.set(nextChild.key, i)
    }
  }

  // -------------------------------------------------------------
  // 5.2 éå†æ—§èŠ‚ç‚¹: Patch (æ‰“è¡¥ä¸) æˆ– Unmount (åˆ é™¤)
  // -------------------------------------------------------------
  let j
  let patched = 0 // å·²å¤ç”¨/æ›´æ–°çš„æ–°èŠ‚ç‚¹æ•°é‡
  const toBePatched = newChildrenEnd - newStartIndex + 1
  let moved = false // æ ‡è®°ä½ï¼šæ˜¯å¦éœ€è¦ç§»åŠ¨èŠ‚ç‚¹
  let maxNewIndexSoFar = 0 // â€œæ°´ä½çº¿â€ï¼šè®°å½•é‡åˆ°çš„æœ€å¤§æ–°ç´¢å¼•

  // newIndexToOldIndexMap: æ ¸å¿ƒæ˜ å°„æ•°ç»„ (å€¼ = oldIndex + 1)
  const newIndexToOldIndexMap = new Array(toBePatched)
  for (i = 0; i < toBePatched; i++) newIndexToOldIndexMap[i] = 0

  // éå†æ—§èŠ‚ç‚¹åˆ—è¡¨
  for (i = oldStartIndex; i <= oldChildrenEnd; i++) {
    const prevChild = oldChildren[i]

    // ã€Unmount ä¼˜åŒ–ã€‘: æ–°èŠ‚ç‚¹å·²æ»¡ï¼Œå‰©ä½™æ—§èŠ‚ç‚¹ç›´æ¥åˆ é™¤
    if (patched >= toBePatched) {
      unmount(prevChild, parentComponent, parentSuspense, true)
      continue
    }

    let newIndex
    if (prevChild.key != null) {
      newIndex = keyToNewIndexMap.get(prevChild.key)
    } else {
      // æ—  key æŸ¥æ‰¾é€»è¾‘ (çœç•¥)
    }

    // ã€Unmountã€‘: æŸ¥æ— æ­¤äººï¼Œåˆ é™¤
    if (newIndex === undefined) {
      unmount(prevChild, parentComponent, parentSuspense, true)
    }
    // ã€Patchã€‘: æ‰¾åˆ°äº†ï¼Œå¤ç”¨
    else {
      newIndexToOldIndexMap[newIndex - newStartIndex] = i + 1

      // ã€Move è§¦å‘åˆ¤æ–­ã€‘: æ£€æŸ¥æ˜¯å¦é€’å¢
      if (newIndex >= maxNewIndexSoFar) {
        maxNewIndexSoFar = newIndex
      } else {
        moved = true // å‡ºç°äº†ä¹±åº (å½“å‰ç´¢å¼• < æ°´ä½çº¿)
      }

      // è§¦å‘æ›´æ–°é€»è¾‘ (å¤ç”¨ DOM)
      patch(prevChild, newChildren[newIndex], container, null, ...)
      patched++
    }
  }

  // -------------------------------------------------------------
  // 5.3 ç§»åŠ¨ä¸æŒ‚è½½ (Move & Mount)
  // -------------------------------------------------------------
  // ä»…å½“ moved ä¸º true æ—¶ï¼Œæ‰è®¡ç®— LIS
  const increasingNewIndexSequence = moved
    ? getSequence(newIndexToOldIndexMap)
    : []

  j = increasingNewIndexSequence.length - 1

  // ã€å€’åºéå†ã€‘
  for (i = toBePatched - 1; i >= 0; i--) {
    const nextIndex = newStartIndex + i
    const nextChild = newChildren[nextIndex]

    // ã€è®¡ç®—é”šç‚¹ã€‘: å–åä¸€ä¸ªèŠ‚ç‚¹çš„ el
    const anchor = nextIndex + 1 < newChildrenLength ? newChildren[nextIndex + 1].el : parentAnchor

    // ã€Patch (Mount)ã€‘: æ˜ å°„å€¼ä¸º 0ï¼Œè¯´æ˜æ˜¯æ–°èŠ‚ç‚¹ï¼Œæ‰§è¡ŒæŒ‚è½½
    if (newIndexToOldIndexMap[i] === 0) {
      patch(null, nextChild, container, anchor, ...)
    }
    // ã€Moveã€‘: éœ€è¦ç§»åŠ¨ (moved=true)
    else if (moved) {
      // å¦‚æœ j < 0 (LIS ç”¨å®Œäº†) æˆ– å½“å‰ç´¢å¼•ä¸ç­‰äº LIS ä¸­çš„å€¼
      if (j < 0 || i !== increasingNewIndexSequence[j]) {
        move(nextChild, container, anchor, 2)
      } else {
        // åœ¨ LIS é‡Œï¼Œä¸åŠ¨
        j--
      }
    }
  }
}

```

### å…³é”®å˜é‡é€ŸæŸ¥è¡¨

| å˜é‡å                           | ç±»å‹      | ä½œç”¨è§£é‡Š                                                                                         |
| -------------------------------- | --------- | ------------------------------------------------------------------------------------------------ |
| **`keyToNewIndexMap`**           | `Map`     | **æŸ¥æ‰¾è¡¨**ã€‚å­˜ `{ key: index }`ï¼Œç”¨äºåœ¨éå†æ—§èŠ‚ç‚¹æ—¶ï¼Œä»¥ `O(1)` çš„é€Ÿåº¦æŸ¥åˆ°å®ƒåœ¨æ–°åˆ—è¡¨ä¸­çš„ä½ç½®ã€‚    |
| **`newIndexToOldIndexMap`**      | `Array`   | **æ˜ å°„è¡¨**ã€‚ç´¢å¼•ä»£è¡¨æ–°èŠ‚ç‚¹ç›¸å¯¹ä½ç½®ï¼Œå€¼ä»£è¡¨æ—§èŠ‚ç‚¹ç´¢å¼•+1ã€‚ç”¨äºåç»­è®¡ç®— LISã€‚                       |
| **`patched`**                    | `Number`  | **è®¡æ•°å™¨**ã€‚è®°å½•å½“å‰å·²ç»æœ‰å¤šå°‘ä¸ªæ—§èŠ‚ç‚¹è¢«æˆåŠŸå¤ç”¨åˆ°æ–°åˆ—è¡¨ä¸­äº†ã€‚                                   |
| **`toBePatched`**                | `Number`  | **æ€»ç›®æ ‡æ•°**ã€‚æ–°åˆ—è¡¨ä¹±åºéƒ¨åˆ†æ€»å…±æœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹éœ€è¦å¤„ç†ã€‚                                           |
| **`moved`**                      | `Boolean` | **å¼€å…³**ã€‚å¦‚æœæ–°èŠ‚ç‚¹ç´¢å¼•ä¸€ç›´é€’å¢ï¼Œè¯´æ˜é¡ºåºæ²¡ä¹±ï¼Œæ­¤å€¼ä¸º falseï¼Œåç»­ä¸éœ€è¦è®¡ç®— LISï¼Œæå¤§æå‡æ€§èƒ½ã€‚ |
| **`maxNewIndexSoFar`**           | `Number`  | **æ°´ä½çº¿**ã€‚è®°å½•éå†è¿‡ç¨‹ä¸­é‡åˆ°çš„æœ€å¤§ç´¢å¼•ã€‚å¦‚æœä¸‹ä¸€ä¸ªç´¢å¼•æ¯”å®ƒå°ï¼Œè¯´æ˜é¡ºåºä¹±äº† (`moved = true`)ã€‚  |
| **`increasingNewIndexSequence`** | `Array`   | **LIS ç»“æœ**ã€‚ä¿å­˜çš„æ˜¯ä¸éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹åœ¨æ–°åˆ—è¡¨ä¸­çš„**ç›¸å¯¹ç´¢å¼•**ã€‚                                 |

## 5. è¿›é˜¶ï¼šç®—æ³•å¤æ‚åº¦åˆ†æ (Complexity Analysis)

Vue 3 çš„ä¹±åº Diff ç®—æ³•åœ¨è¿½æ±‚â€œæœ€å° DOM æ“ä½œâ€çš„åŒæ—¶ï¼Œä¹Ÿæå¥½åœ°æ§åˆ¶äº†è®¡ç®—æˆæœ¬ã€‚æˆ‘ä»¬æ¥æ‹†è§£æ¯ä¸€æ­¥çš„æ—¶é—´å’Œç©ºé—´æ¶ˆè€—ã€‚

### 5.1 æ—¶é—´å¤æ‚åº¦ (Time Complexity)

å‡è®¾æ—§èŠ‚ç‚¹æ•°é‡ä¸º `n`ï¼Œæ–°èŠ‚ç‚¹ä¹±åºéƒ¨åˆ†æ•°é‡ä¸º `m`ã€‚

1. **å»ºç«‹ç´¢å¼•å›¾ (Build Map)**
   - æ“ä½œï¼šéå†æ–°èŠ‚ç‚¹åˆ—è¡¨ï¼Œå†™å…¥ Mapã€‚
   - å¤æ‚åº¦ï¼š**`O(m)`**ã€‚

2. **éå†æ—§èŠ‚ç‚¹ (Clean Old)**
   - æ“ä½œï¼šéå†æ—§èŠ‚ç‚¹åˆ—è¡¨ï¼ŒæŸ¥ Map (æŸ¥æ‰¾ä¸º `O(1)`)ï¼Œå¡«å……æ•°ç»„ã€‚
   - å¤æ‚åº¦ï¼š**`O(n)`**ã€‚

3. **è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ— (LIS)**
   - æ“ä½œï¼šè¿™æ˜¯çº¯è®¡ç®—éƒ¨åˆ†æœ€è€—æ—¶çš„æ­¥éª¤ã€‚Vue ä½¿ç”¨äº† **è´ªå¿ƒ + äºŒåˆ†æŸ¥æ‰¾** çš„ç­–ç•¥ã€‚
   - ç»†èŠ‚ï¼šéå†æ•°ç»„ (`O(m)`)ï¼Œå¯¹æ¯ä¸ªå…ƒç´ è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ (`O(log m)`)ã€‚
   - å¤æ‚åº¦ï¼š**`O(m log m)`**ã€‚
   - _æ³¨ï¼šå¦‚æœæ˜¯æœ´ç´ çš„åŠ¨æ€è§„åˆ’ `O(mÂ²)`ï¼Œåœ¨èŠ‚ç‚¹å¤šæ—¶ä¼šå¡é¡¿ï¼ŒVue ä¼˜åŒ–åˆ°äº† `O(m log m)`ã€‚_

4. **å€’åºéå†ä¸ç§»åŠ¨ (Move & Mount)**
   - æ“ä½œï¼šå†æ¬¡éå†æ–°èŠ‚ç‚¹åˆ—è¡¨ï¼Œè¿›è¡Œ DOM æ’å…¥ã€‚
   - å¤æ‚åº¦ï¼š**`O(m)`**ã€‚

**ğŸ”´ æ€»æ—¶é—´å¤æ‚åº¦ï¼š** **`O(n + m log m)`**

### 5.2 ç©ºé—´å¤æ‚åº¦ (Space Complexity)

æˆ‘ä»¬éœ€è¦é¢å¤–çš„å†…å­˜æ¥å­˜å‚¨è¾…åŠ©ç»“æ„ï¼Œä»¥æ¢å–æ—¶é—´æ•ˆç‡ï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰ã€‚

1. **`keyToNewIndexMap`**ï¼šå­˜å‚¨æ–°èŠ‚ç‚¹çš„ Key å’Œ Indexã€‚
   - æ¶ˆè€—ï¼š**`O(m)`**ã€‚

2. **`newIndexToOldIndexMap`**ï¼šå­˜å‚¨æ–°æ—§ä½ç½®æ˜ å°„ã€‚
   - æ¶ˆè€—ï¼š**`O(m)`**ã€‚

3. **LIS ç®—æ³•è¾…åŠ©æ•°ç»„**ï¼š`p` æ•°ç»„ï¼ˆå‰é©±ï¼‰å’Œ `result` æ•°ç»„ï¼ˆç»“æœï¼‰ã€‚
   - æ¶ˆè€—ï¼š**`O(m)`**ã€‚

**ğŸ”µ æ€»ç©ºé—´å¤æ‚åº¦ï¼š** **`O(m)`**

### 5.3 æ ¸å¿ƒæƒè¡¡ï¼šä¸ºä»€ä¹ˆè¦ç”¨ `O(m log m)`ï¼Ÿ

ä½ å¯èƒ½ä¼šé—®ï¼š_"ç®€å•ç²—æš´åœ°ç§»åŠ¨ä¸æ˜¯æ›´å¿«å—ï¼Ÿä¸ºä»€ä¹ˆè¦èŠ± `O(m log m)` çš„ CPU æ—¶é—´å»ç®— LISï¼Ÿ"_

è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„ **è®¡ç®—æˆæœ¬ vs æ¸²æŸ“æˆæœ¬** çš„åšå¼ˆï¼š

- **JS è®¡ç®— (CPU)**ï¼šéå¸¸å¿«ã€‚ç°ä»£æµè§ˆå™¨æ‰§è¡Œ `O(m log m)` çš„ JS è®¡ç®—å‡ ä¹æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ï¼ˆå³ä½¿ `m = 1000`ï¼Œä¹Ÿåªæ˜¯å‡ å¾®ç§’ï¼‰ã€‚
- **DOM æ“ä½œ (GPU/Layout)**ï¼šéå¸¸æ…¢ã€‚æ¯ä¸€æ¬¡ `insertBefore` æˆ– `appendChild` éƒ½å¯èƒ½è§¦å‘æµè§ˆå™¨çš„ **é‡æ’ (Reflow)** å’Œ **é‡ç»˜ (Repaint)**ã€‚

**ç»“è®ºï¼š**
Vue 3 é€‰æ‹©å¤šèŠ±ä¸€ç‚¹ç‚¹ JS è®¡ç®—æ—¶é—´ï¼Œç®—å‡º"æœ€å®Œç¾çš„ç§»åŠ¨æ–¹æ¡ˆ"ï¼Œä»è€Œ**æœ€å¤§ç¨‹åº¦åœ°å‡å°‘æ˜‚è´µçš„ DOM æ“ä½œ**ã€‚è¿™åœ¨å¤„ç†å¤§å‹åˆ—è¡¨æ›´æ–°æ—¶ï¼Œèƒ½å¸¦æ¥è‚‰çœ¼å¯è§çš„æ€§èƒ½æå‡ã€‚

## 6. é™„å½•ï¼šLIS ç®—æ³•åŸç† (éšå¼æ ‘ä¸è´ªå¿ƒ)

åœ¨ `getSequence` å‡½æ•°ä¸­ï¼ŒVue 3 ä½¿ç”¨äº† **è´ªå¿ƒ + äºŒåˆ† + å›æº¯** çš„ç­–ç•¥ã€‚

- **éšå¼æ ‘ç»“æ„ (`p` æ•°ç»„)**ï¼š`p[i] = j` è¡¨ç¤ºèŠ‚ç‚¹ `i` çš„å‰é©±æ˜¯ `j`ã€‚è¿™å®é™…ä¸Šåœ¨æ•°ç»„ä¸­æ„å»ºäº†ä¸€æ£µå€’ç½®çš„æ ‘ã€‚
- **å›æº¯**ï¼šæœ€åé€šè¿‡ `result` çš„æœ«å°¾å…ƒç´ ï¼ˆHEAD æŒ‡é’ˆï¼‰ï¼Œåˆ©ç”¨ `p` æ•°ç»„ä¸€æ­¥æ­¥å¾€å›æ‰¾ï¼Œè¿˜åŸå‡ºé‚£æ¡æœ€é•¿çš„è·¯å¾„ã€‚
- **è´ªå¿ƒæŠ‰æ‹©**ï¼šç®—æ³•æ€»æ˜¯å€¾å‘äºé€‰æ‹©â€œç»“å°¾æ›´å°â€çš„åºåˆ—ï¼Œå› ä¸ºç»“å°¾è¶Šå°ï¼Œåé¢èƒ½æ¥çº³çš„æ•°å­—å°±è¶Šå¤šï¼ˆæ½œåŠ›è¶Šå¤§ï¼‰ã€‚ä¾‹å¦‚é€‰æ‹© `2, 3, 4, 9` è€Œä¸æ˜¯ `2, 5, 8, 9`ï¼Œå› ä¸º `4 < 8`ï¼Œ`4` çš„æ½œåŠ›æ¯” `8` å¤§ã€‚

{{< article link="/posts/vue3-lis-algorithm-deep-dive/" showSummary=true compactSummary=true >}}

## 7. æ€»ç»“

### ä¸ºä»€ä¹ˆ Vue 3 çš„ Diff è¿™ä¹ˆå¿«ï¼Ÿ

1. **Map æŸ¥æ‰¾**ï¼šå°†éå†æŸ¥æ‰¾çš„ `O(n Ã— m)` é™ä¸º `O(n)`ã€‚
2. **Unmount ä¼˜åŒ–**ï¼šä¸€æ—¦æ–°èŠ‚ç‚¹åé¢ (`toBePatched`) å¡«æ»¡ï¼Œå‰©ä½™æ—§èŠ‚ç‚¹æ‰¹é‡åˆ é™¤ï¼Œä¸èµ°æŸ¥æ‰¾é€»è¾‘ã€‚
3. **LIS ç®—æ³•**ï¼šè¿™æ˜¯æœ€ç²¾é«“çš„éƒ¨åˆ†ã€‚é€šè¿‡è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ—ï¼Œä¿è¯äº† **DOM ç§»åŠ¨æ¬¡æ•°æœ€å°‘**ã€‚
4. **å€’åºæ’å…¥**ï¼šé€šè¿‡å€’åºéå†ï¼Œåˆ©ç”¨å·²å¤„ç†çš„èŠ‚ç‚¹ä½œä¸ºé”šç‚¹ï¼Œå·§å¦™è§£å†³äº† `insertBefore` éœ€è¦å‚ç…§ç‰©çš„é—®é¢˜ã€‚
